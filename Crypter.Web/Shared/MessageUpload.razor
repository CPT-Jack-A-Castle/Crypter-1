@inject IJSRuntime jsRuntime

<div class="message-upload" hidden="@IsEncrypting">
    <div class="row">
        <div class="col-12 p-0">
            <textarea @bind="MessageText" @bind:event="oninput" id="messageText" name="messageText" rows="5" cols="57" placeholder="Type your message here..." maxlength="@MaxMessageLength"></textarea>
            <label><small class="align-text-bottom">@(MaxMessageLength - MessageText.Count()) remaining</small></label>
        </div>
    </div>
    <div class="row">
        <div class="col-12 p-0">
            <button type="button" class="btn btn-primary" @onclick="@(e => EncryptMessage(MessageText, rsaKeySize))">Encrypt</button>
        </div>
    </div>
    <UploadSuccessModal @ref="Modal" @bind-DataFormat="dataFormat" @bind-PublicKey="publicKey" @bind-PrivateKey="privateKey" />
</div>

<h3 hidden="@(!IsEncrypting)">Encryption Processing</h3>

@code {
    const int MaxMessageLength = 1024;
    string MessageText = "";
    string publicKey;
    string privateKey;
    string dataFormat;
    private bool IsEncrypting = false;


    RsaKeySize rsaKeySize = RsaKeySize._1024;

    private void EncryptMessage(string message, RsaKeySize rsaKeySize)
    {
        // Set is encrypting to true
        IsEncrypting = true;

        // Refer to https://stackoverflow.com/a/11701301 for procedure

        byte[] messageBytes = Encoding.UTF8.GetBytes(message);
        var clientEncryptResult = CryptoLib.Common.DoAnonymousClientEncryption(messageBytes, rsaKeySize);

        // Send this to the API
        Console.WriteLine(clientEncryptResult.CipherText);
        Console.WriteLine(clientEncryptResult.Signature);
        Console.WriteLine(clientEncryptResult.ServerEncryptionKey);

        // Send data to success modal component
        KeyGenerated(clientEncryptResult.KeyPair.Public.ConvertToPEM(), clientEncryptResult.KeyPair.Private.ConvertToPEM());

        // Set Data Format
        dataFormat = "message";

        // Open modal on key generation
        Modal.Open();

        // Reset message text
        MessageText = "";

        // No longer encrypting
        IsEncrypting = false;
    }

    public void KeyGenerated(string pubKey, string privKey)
    {
        publicKey = pubKey;
        privateKey = privKey;
    }

    private Crypter.Web.Shared.UploadSuccessModal Modal { get; set; }
}
